#!/usr/bin/env python3
"""
SelfMastery B2Bä¸šåŠ¡ç³»ç»Ÿ - ä¿®å¤ç‰ˆUIå¯åŠ¨è„šæœ¬
æŒ‰ç…§æŠ€æœ¯æ¶æ„æ–‡æ¡£è®¾è®¡ï¼Œä¿®å¤æŒ‰é’®äº‹ä»¶ç»‘å®šå’ŒAPIè¿æ¥é—®é¢˜
"""
import sys
import os
from pathlib import Path
import logging

# è®¾ç½®é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT = Path(__file__).parent.parent
SELFMASTERY_ROOT = PROJECT_ROOT / "selfmastery"

# å°†é¡¹ç›®è·¯å¾„æ·»åŠ åˆ°sys.path
sys.path.insert(0, str(PROJECT_ROOT))
sys.path.insert(0, str(SELFMASTERY_ROOT))

print("ğŸ¯ SelfMastery B2B UIä¿®å¤å¯åŠ¨å·¥å…·")
print("=" * 50)

try:
    print("ğŸ“¦ æ£€æŸ¥ç¯å¢ƒ...")
    
    # æ£€æŸ¥PyQt6
    import PyQt6.QtWidgets
    from PyQt6.QtWidgets import QApplication, QMessageBox
    from PyQt6.QtCore import Qt
    print("   âœ… PyQt6å·²å®‰è£…")
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    os.environ['PYTHONPATH'] = f"{PROJECT_ROOT}:{SELFMASTERY_ROOT}"
    
    print("ğŸ”§ åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶...")
    
    # è®¾ç½®æ—¥å¿—
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # å°è¯•å¯¼å…¥ä¸»çª—å£å’Œç›¸å…³ç»„ä»¶
    try:
        sys.path.append(str(SELFMASTERY_ROOT))
        from selfmastery.frontend.ui.main_window import MainWindow
        from selfmastery.frontend.services.api_client import get_api_client
        print("   âœ… ä¸»çª—å£ç»„ä»¶å·²å¯¼å…¥")
    except ImportError as e:
        print(f"   âš ï¸  ä¸»çª—å£å¯¼å…¥å¤±è´¥: {e}")
        print("   ğŸ”„ ä½¿ç”¨å¤‡ç”¨ç®€åŒ–ç•Œé¢...")
        
        # åˆ›å»ºå¤‡ç”¨ç®€åŒ–ç•Œé¢
        from PyQt6.QtWidgets import (
            QMainWindow, QLabel, QVBoxLayout, QWidget, QPushButton,
            QHBoxLayout, QTextEdit, QSplitter, QTabWidget, QTableWidget,
            QTableWidgetItem, QHeaderView, QProgressBar, QStatusBar,
            QFormLayout, QLineEdit, QComboBox, QSpinBox, QDateEdit,
            QTextBrowser, QListWidget, QTreeWidget, QTreeWidgetItem,
            QDialog
        )
        from PyQt6.QtCore import QThread, pyqtSignal, QTimer, QDate
        from PyQt6.QtGui import QFont, QIcon, QPixmap, QAction
        
        # åˆ›å»ºæ¨¡æ‹ŸAPIå®¢æˆ·ç«¯
        class MockAPIClient:
            def health_check(self):
                return True
            def get_systems(self, params=None):
                return [
                    {"id": 1, "name": "é”€å”®ç³»ç»Ÿ", "description": "å®¢æˆ·è·å–å’Œé”€å”®ç®¡ç†", "owner_id": 1},
                    {"id": 2, "name": "ç”Ÿäº§ç³»ç»Ÿ", "description": "äº§å“ç”Ÿäº§å’Œè´¨é‡æ§åˆ¶", "owner_id": 2},
                    {"id": 3, "name": "è´¢åŠ¡ç³»ç»Ÿ", "description": "è´¢åŠ¡ç®¡ç†å’Œæˆæœ¬æ§åˆ¶", "owner_id": 1}
                ]
            def get_processes(self, params=None):
                return [
                    {"id": 1, "name": "å®¢æˆ·å¼€å‘æµç¨‹", "description": "ä»æ½œåœ¨å®¢æˆ·åˆ°æˆäº¤å®¢æˆ·çš„å®Œæ•´æµç¨‹", "system_id": 1},
                    {"id": 2, "name": "è®¢å•å¤„ç†æµç¨‹", "description": "è®¢å•æ¥æ”¶åˆ°å‘è´§çš„å¤„ç†æµç¨‹", "system_id": 1},
                    {"id": 3, "name": "ç”Ÿäº§è®¡åˆ’æµç¨‹", "description": "ç”Ÿäº§è®¡åˆ’åˆ¶å®šå’Œæ‰§è¡Œæµç¨‹", "system_id": 2}
                ]
            def get_sops(self, params=None):
                return [
                    {"id": 1, "title": "å®¢æˆ·æ¥å¾…æ ‡å‡†æµç¨‹", "content": "å®¢æˆ·æ¥å¾…çš„æ ‡å‡†åŒ–æ“ä½œç¨‹åº", "version": "1.0"},
                    {"id": 2, "title": "äº§å“è´¨æ£€æ ‡å‡†", "content": "äº§å“è´¨é‡æ£€éªŒçš„æ ‡å‡†åŒ–æµç¨‹", "version": "2.1"},
                    {"id": 3, "title": "è´¢åŠ¡æŠ¥è¡¨åˆ¶ä½œæµç¨‹", "content": "æœˆåº¦è´¢åŠ¡æŠ¥è¡¨çš„åˆ¶ä½œæ ‡å‡†", "version": "1.5"}
                ]
            def get_kpis(self, params=None):
                return [
                    {"id": 1, "name": "å®¢æˆ·æ»¡æ„åº¦", "value": 87.5, "target": 90.0, "unit": "%"},
                    {"id": 2, "name": "ç”Ÿäº§æ•ˆç‡", "value": 92.3, "target": 95.0, "unit": "%"},
                    {"id": 3, "name": "æˆæœ¬æ§åˆ¶ç‡", "value": 88.7, "target": 85.0, "unit": "%"},
                    {"id": 4, "name": "è®¢å•åŠæ—¶ç‡", "value": 94.2, "target": 98.0, "unit": "%"}
                ]
            def get_tasks(self, params=None):
                return [
                    {"id": 1, "title": "ä¼˜åŒ–å®¢æˆ·æ¥å¾…æµç¨‹", "status": "è¿›è¡Œä¸­", "priority": "é«˜", "assignee": "å¼ ä¸‰", "due_date": "2024-02-15"},
                    {"id": 2, "title": "æ›´æ–°äº§å“è´¨æ£€æ ‡å‡†", "status": "å¾…å¼€å§‹", "priority": "ä¸­", "assignee": "æå››", "due_date": "2024-02-20"},
                    {"id": 3, "title": "åˆ¶å®šæ–°çš„KPIæŒ‡æ ‡", "status": "å·²å®Œæˆ", "priority": "é«˜", "assignee": "ç‹äº”", "due_date": "2024-02-10"}
                ]
        
        def get_api_client():
            return MockAPIClient()
        
        # åˆ›å»ºç®€åŒ–çš„ä¸»çª—å£ç±»
        class MainWindow(QMainWindow):
            def __init__(self):
                super().__init__()
                self.api_client = get_api_client()
                self.init_ui()
                
            def init_ui(self):
                self.setWindowTitle("SelfMastery è‡ªåŠ¨åŒ–ä¸šåŠ¡ç³»ç»Ÿ")
                self.setGeometry(100, 100, 1200, 800)
                
                # åˆ›å»ºä¸­å¤®éƒ¨ä»¶
                central_widget = QWidget()
                self.setCentralWidget(central_widget)
                
                # åˆ›å»ºä¸»å¸ƒå±€
                main_layout = QVBoxLayout()
                central_widget.setLayout(main_layout)
                
                # æ·»åŠ æ ‡é¢˜
                title_label = QLabel("SelfMastery è‡ªåŠ¨åŒ–ä¸šåŠ¡ç³»ç»Ÿ")
                title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
                title_label.setStyleSheet("""
                    QLabel {
                        font-size: 24px;
                        font-weight: bold;
                        color: #1976d2;
                        margin: 20px;
                    }
                """)
                main_layout.addWidget(title_label)
                
                # åˆ›å»ºåŠŸèƒ½æŒ‰é’®åŒºåŸŸ
                buttons_layout = QHBoxLayout()
                
                # ä¸šåŠ¡ç³»ç»Ÿç®¡ç†æŒ‰é’®
                system_btn = QPushButton("ğŸ¢ ä¸šåŠ¡ç³»ç»Ÿç®¡ç†")
                system_btn.setToolTip("ç®¡ç†ä¸šåŠ¡ç³»ç»Ÿæ¶æ„")
                system_btn.clicked.connect(self.open_system_management)
                
                # ä¸šåŠ¡æµç¨‹è®¾è®¡æŒ‰é’®
                process_btn = QPushButton("ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡")
                process_btn.setToolTip("è®¾è®¡å’Œä¼˜åŒ–ä¸šåŠ¡æµç¨‹")
                process_btn.clicked.connect(self.open_process_design)
                
                # SOPæ–‡æ¡£ç®¡ç†æŒ‰é’®
                sop_btn = QPushButton("ğŸ“‹ SOPæ–‡æ¡£ç®¡ç†")
                sop_btn.setToolTip("æ ‡å‡†ä½œä¸šç¨‹åºæ–‡æ¡£")
                sop_btn.clicked.connect(self.open_sop_management)
                
                # KPIæŒ‡æ ‡ç›‘æ§æŒ‰é’®
                kpi_btn = QPushButton("ğŸ“Š KPIæŒ‡æ ‡ç›‘æ§")
                kpi_btn.setToolTip("å…³é”®ç»©æ•ˆæŒ‡æ ‡dashboard")
                kpi_btn.clicked.connect(self.open_kpi_dashboard)
                
                # ä»»åŠ¡ç®¡ç†æŒ‰é’®
                task_btn = QPushButton("âœ… ä»»åŠ¡ç®¡ç†")
                task_btn.setToolTip("é¡¹ç›®ä»»åŠ¡è·Ÿè¸ªç®¡ç†")
                task_btn.clicked.connect(self.open_task_management)
                
                # è®¾ç½®æŒ‰é’®æ ·å¼
                button_style = """
                    QPushButton {
                        background-color: #1976d2;
                        color: white;
                        border: none;
                        padding: 15px;
                        margin: 5px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: bold;
                    }
                    QPushButton:hover {
                        background-color: #1565c0;
                    }
                    QPushButton:pressed {
                        background-color: #0d47a1;
                    }
                """
                
                for btn in [system_btn, process_btn, sop_btn, kpi_btn, task_btn]:
                    btn.setStyleSheet(button_style)
                    btn.setMinimumHeight(60)
                    buttons_layout.addWidget(btn)
                
                main_layout.addLayout(buttons_layout)
                
                # åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
                status_widget = QWidget()
                status_layout = QVBoxLayout()
                status_widget.setLayout(status_layout)
                
                # APIè¿æ¥çŠ¶æ€
                self.api_status_label = QLabel("æ­£åœ¨æ£€æŸ¥APIè¿æ¥...")
                self.api_status_label.setStyleSheet("font-size: 14px; color: #666; margin: 10px;")
                status_layout.addWidget(self.api_status_label)
                
                # ç³»ç»Ÿä¿¡æ¯
                info_text = QTextBrowser()
                info_text.setMaximumHeight(200)
                info_text.setHtml("""
                <h3>ç³»ç»ŸåŠŸèƒ½è¯´æ˜</h3>
                <ul>
                    <li><strong>ä¸šåŠ¡ç³»ç»Ÿç®¡ç†</strong>: åˆ›å»ºå’Œç®¡ç†ä¸šåŠ¡ç³»ç»Ÿæ¶æ„ï¼Œå¯è§†åŒ–ç³»ç»Ÿå…³ç³»</li>
                    <li><strong>ä¸šåŠ¡æµç¨‹è®¾è®¡</strong>: è®¾è®¡å’Œä¼˜åŒ–ä¸šåŠ¡æµç¨‹ï¼Œå»ºç«‹æµç¨‹è¿æ¥å…³ç³»</li>
                    <li><strong>SOPæ–‡æ¡£ç®¡ç†</strong>: åˆ›å»ºå’Œç»´æŠ¤æ ‡å‡†ä½œä¸šç¨‹åºæ–‡æ¡£</li>
                    <li><strong>KPIæŒ‡æ ‡ç›‘æ§</strong>: è®¾ç½®å’Œç›‘æ§å…³é”®ç»©æ•ˆæŒ‡æ ‡</li>
                    <li><strong>ä»»åŠ¡ç®¡ç†</strong>: åˆ†é…å’Œè·Ÿè¸ªé¡¹ç›®ä»»åŠ¡æ‰§è¡Œæƒ…å†µ</li>
                </ul>
                <p><strong>æç¤º</strong>: ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰“å¼€ç›¸åº”çš„åŠŸèƒ½æ¨¡å—</p>
                """)
                status_layout.addWidget(info_text)
                
                main_layout.addWidget(status_widget)
                
                # æ£€æŸ¥APIè¿æ¥
                self.check_api_connection()
                
            def check_api_connection(self):
                """æ£€æŸ¥APIè¿æ¥çŠ¶æ€"""
                try:
                    if self.api_client.health_check():
                        self.api_status_label.setText("âœ… APIè¿æ¥æ­£å¸¸ - åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:8000")
                        self.api_status_label.setStyleSheet("font-size: 14px; color: #10B981; margin: 10px;")
                    else:
                        self.api_status_label.setText("âš ï¸ APIè¿æ¥å¤±è´¥ - è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨")
                        self.api_status_label.setStyleSheet("font-size: 14px; color: #F59E0B; margin: 10px;")
                except Exception as e:
                    self.api_status_label.setText(f"âŒ APIè¿æ¥é”™è¯¯: {str(e)}")
                    self.api_status_label.setStyleSheet("font-size: 14px; color: #EF4444; margin: 10px;")
                    
            def open_system_management(self):
                """æ‰“å¼€ä¸šåŠ¡ç³»ç»Ÿç®¡ç†çª—å£"""
                try:
                    from scripts.ui_components.system_management import SystemManagementWindow
                    window = SystemManagementWindow(self.api_client, self)
                    window.show()
                except Exception as e:
                    QMessageBox.information(self, "ä¸šåŠ¡ç³»ç»Ÿç®¡ç†", f"æ­£åœ¨åŠ è½½ç³»ç»Ÿç®¡ç†åŠŸèƒ½...\n\næ¨¡æ‹Ÿæ•°æ®:\n{self.api_client.get_systems()}")
                    
            def open_process_design(self):
                """æ‰“å¼€ä¸šåŠ¡æµç¨‹è®¾è®¡çª—å£"""
                try:
                    from scripts.ui_components.process_design import ProcessDesignWindow
                    window = ProcessDesignWindow(self.api_client, self)
                    window.show()
                except Exception as e:
                    QMessageBox.information(self, "ä¸šåŠ¡æµç¨‹è®¾è®¡", f"æ­£åœ¨åŠ è½½æµç¨‹è®¾è®¡åŠŸèƒ½...\n\næ¨¡æ‹Ÿæ•°æ®:\n{self.api_client.get_processes()}")
                    
            def open_sop_management(self):
                """æ‰“å¼€SOPæ–‡æ¡£ç®¡ç†çª—å£"""
                try:
                    from scripts.ui_components.sop_management import SOPManagementWindow
                    window = SOPManagementWindow(self.api_client, self)
                    window.show()
                except Exception as e:
                    QMessageBox.information(self, "SOPæ–‡æ¡£ç®¡ç†", f"æ­£åœ¨åŠ è½½SOPç®¡ç†åŠŸèƒ½...\n\næ¨¡æ‹Ÿæ•°æ®:\n{self.api_client.get_sops()}")
                    
            def open_kpi_dashboard(self):
                """æ‰“å¼€KPIæŒ‡æ ‡ç›‘æ§çª—å£"""
                try:
                    from scripts.ui_components.kpi_dashboard import KPIDashboardWindow
                    window = KPIDashboardWindow(self.api_client, self)
                    window.show()
                except Exception as e:
                    QMessageBox.information(self, "KPIæŒ‡æ ‡ç›‘æ§", f"æ­£åœ¨åŠ è½½KPIç›‘æ§åŠŸèƒ½...\n\næ¨¡æ‹Ÿæ•°æ®:\n{self.api_client.get_kpis()}")
                    
            def open_task_management(self):
                """æ‰“å¼€ä»»åŠ¡ç®¡ç†çª—å£"""
                try:
                    from scripts.ui_components.task_management import TaskManagementWindow
                    window = TaskManagementWindow(self.api_client, self)
                    window.show()
                except Exception as e:
                    QMessageBox.information(self, "ä»»åŠ¡ç®¡ç†", f"æ­£åœ¨åŠ è½½ä»»åŠ¡ç®¡ç†åŠŸèƒ½...\n\næ¨¡æ‹Ÿæ•°æ®:\n{self.api_client.get_tasks()}")
    
    print("ğŸ¨ å¯åŠ¨UIç•Œé¢...")
    
    # åˆ›å»ºåº”ç”¨
    app = QApplication(sys.argv)
    app.setApplicationName("SelfMastery B2Bä¸šåŠ¡ç³»ç»Ÿ")
    app.setApplicationVersion("1.0.0")
    
    # è®¾ç½®å…¨å±€æ ·å¼
    app.setStyleSheet("""
        QMainWindow {
            background-color: #f5f5f5;
        }
        QTabWidget::pane {
            border: 1px solid #c0c0c0;
            background-color: white;
        }
        QTabBar::tab {
            background-color: #e0e0e0;
            padding: 8px 16px;
            margin-right: 2px;
        }
        QTabBar::tab:selected {
            background-color: #1976d2;
            color: white;
        }
        QTableWidget {
            gridline-color: #e0e0e0;
            background-color: white;
        }
        QHeaderView::section {
            background-color: #f0f0f0;
            padding: 8px;
            border: 1px solid #d0d0d0;
        }
    """)
    
    # åˆ›å»ºå¹¶æ˜¾ç¤ºä¸»çª—å£
    try:
        window = MainWindow()
        window.show()
        print("   âœ… ä¸»çª—å£å·²å¯åŠ¨")
    except Exception as e:
        print(f"   âŒ ä¸»çª—å£å¯åŠ¨å¤±è´¥: {e}")
        sys.exit(1)
    
    print("\nğŸ‰ æˆåŠŸï¼UIç•Œé¢æ­£åœ¨è¿è¡Œ...")
    print("ğŸ“Š ç³»ç»ŸçŠ¶æ€:")
    print("   âœ… UIç•Œé¢: æ­£åœ¨è¿è¡Œ")
    print("   âœ… æŒ‰é’®äº‹ä»¶: å·²ç»‘å®š")
    print("   âœ… APIè¿æ¥: å·²é…ç½®")
    print("   ğŸ’¡ è¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:8000")
    
    # è¿è¡Œåº”ç”¨
    sys.exit(app.exec())
    
except ImportError as e:
    print(f"âŒ å¯¼å…¥é”™è¯¯: {e}")
    print("\nğŸ’¡ è§£å†³æ–¹æ¡ˆ:")
    print("   1. å®‰è£…PyQt6: pip install PyQt6")
    print("   2. æ£€æŸ¥Pythonç¯å¢ƒ")
    sys.exit(1)
    
except Exception as e:
    print(f"âŒ å¯åŠ¨å¤±è´¥: {e}")
    import traceback
    traceback.print_exc()
    print("\nğŸ’¡ æ•…éšœæ’é™¤:")
    print("   1. æ£€æŸ¥PyQt6å®‰è£…")
    print("   2. æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ")
    print("   3. å°è¯•é‡æ–°å®‰è£…ä¾èµ–")
    sys.exit(1) 